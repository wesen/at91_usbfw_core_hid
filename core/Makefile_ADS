#/* ----------------------------------------------------------------------------
# *         ATMEL Microcontroller Software Support  -  ROUSSET  -
# * ----------------------------------------------------------------------------
# * Copyright (c) 2006, Atmel Corporation
#
# * All rights reserved.
# *
# * Redistribution and use in source and binary forms, with or without
# * modification, are permitted provided that the following conditions are met:
# *
# * - Redistributions of source code must retain the above copyright notice,
# * this list of conditions and the disclaiimer below.
# *
# * - Redistributions in binary form must reproduce the above copyright notice,
# * this list of conditions and the disclaimer below in the documentation and/or
# * other materials provided with the distribution.
# *
# * Atmel`s name may not be used to endorse or promote products derived from
# * this software without specific prior written permission.
# *
# * DISCLAIMER: THIS SOFTWARE IS PROVIDED BY ATMEL "AS IS" AND ANY EXPRESS OR
# * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF
# * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT ARE
# * DISCLAIMED. IN NO EVENT SHALL ATMEL BE LIABLE FOR ANY DIRECT, INDIRECT,
# * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
# * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA,
# * OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
# * LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
# * NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE,
# * EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
# * ----------------------------------------------------------------------------
# */

# $Id: Makefile 108 2006-10-16 08:33:33Z jjoannic $

#-------------------------------------------------------------------------------
#       Use
#-------------------------------------------------------------------------------
#
#   Do not call this file directly, use the topmost Makefile instead.
#
#-------------------------------------------------------------------------------

#-------------------------------------------------------------------------------
#       Tools
#-------------------------------------------------------------------------------

AS = armasm
LD = armlink
FE = fromelf
THUMB_CC = tcc
ARM_CC = armcc
CC = $(THUMB_CC)

#-------------------------------------------------------------------------------
#       Debug mode
#-------------------------------------------------------------------------------

!IF "$(DEBUG)" == "YES"
OPTIMIZATION = -O0 -Ono_inline -g+
!ELSE
OPTIMIZATION = -O2
!ENDIF

#-------------------------------------------------------------------------------
#       Compilation flags
#-------------------------------------------------------------------------------

CCFLAGS = -apcs /interwork -gtp -Wb+avnglp -D__APCS_INTERWORK\
          $(OPTIMIZATION) -D$(TARGET) -D$(BOARD) -I$(LIB) -I./

!IF "$(LEDS)" == "NO"
CCFLAGS = $(CCFLAGS) -DNOLEDS
!ENDIF

!IF "$(TRACES)" == "NO"
CCFLAGS = $(CCFLAGS) -DNOTRACES
!ENDIF

!IF "$(POWER)" == "BUS"
CCFLAGS = $(CCFLAGS) -DUSB_BUS_POWERED
!ENDIF

!IF "$(MODE)" != "NO"
CCFLAGS = $(CCFLAGS) -D$(MODE)
!ENDIF

#-------------------------------------------------------------------------------
#       Linker flags
#-------------------------------------------------------------------------------

LDFLAGS = -nolocals

!IF "$(DEBUG)" == "NO"
LDFLAGS = $(LDFLAGS) -nodebug
!ENDIF


#-------------------------------------------------------------------------------
#       Object files
#-------------------------------------------------------------------------------

OUTPUT = core.o
OBJECTS = udp.o device.o board.o at91stdio.o standard.o

!IF "$(CLASS)" == "ENUM"
OBJECTS = $(OBJECTS) enumeration_example.o
!ENDIF

#-------------------------------------------------------------------------------
#       Directives
#-------------------------------------------------------------------------------

all: $(OUTPUT)

$(OBJECTS): $(@B).c
    @echo Building $@ ...
    @if not exist $(OBJ) mkdir $(OBJ)
    @$(CC) -c $(CCFLAGS) $? -o $(OBJ)/$@

$(OUTPUT): $(OBJECTS)
    @echo Linking $@ ...
    @cd $(OBJ)
    @$(LD) -partial -output $(OUTPUT) $(LDFLAGS) $?
